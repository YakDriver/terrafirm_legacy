---
version: 0.2

env:
  variables:
    TF_ZIP: https://releases.hashicorp.com/terraform/0.11.1/terraform_0.11.1_linux_amd64.zip
    TERRAFIRM_DESC_URL: https://github.com/YakDriver/terrafirm
  parameter-store:
    NAMED_PROFILE: "/CodeBuild/terrafirm/named_profile"
    SSH_KEY: "/CodeBuild/terrafirm/ssh_key"

phases:
  install:
    commands:
      - echo "Installing unzip............"
      - apt -y install unzip
      - echo "Installing Terraform..."
      - echo `pwd`
      - curl -L "${TF_ZIP}" -o tf.zip && unzip tf.zip
      - echo "Installed Terraform."
  pre_build:
    commands:
      - |
        if [ -z "${NAMED_PROFILE}" ]
        then
          echo "No named profile given, using default (terrafirm)..."
          NAMED_PROFILE=terrafirm
          export NAMED_PROFILE
        fi
      - |
        if [ -n "${AWS_REGION}" ]
        then
          aws configure set region $AWS_REGION --profile $NAMED_PROFILE
        fi
      - echo "Terraform version " ; ./terraform --version
      - echo "Terraform config file " ; cat terrafirm.tf
      #- echo "Initializing Terraform " ; TF_VAR_ssh_key="${SSH_KEY}" ./terraform init -input=false
      - echo "Initializing Terraform " ; ./terraform init -input=false
      - echo "Create provisiong plan " ; ./terraform plan -out=tfplan -input=false
      - 
  build:
    commands:
      - echo "Applying Terraform plan (which installs watchmaker) "
      - echo "NOTE, this will fail if remote execute calls fail"
      - ./terraform apply -input=false tfplan
  post_build:
    commands:
      - echo "Destroying everything..."
      - ./terraform destroy -input=false -force
      - echo "Terrafirm completed on $(date)"

artifacts:
  files:
    - '**/*'
